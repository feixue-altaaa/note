# 分层协议

## 协议和服务的关系？

- 协议是为进行网络中数据交换而建立的规则、标准或规定称为网络协议，简称协议。控制两个对等实体(或多个实体)进行通信的规则的集合
- 服务是指下层为紧邻的上层提供的功能调用，也就是垂直的。对等实体在协议的控制下，使得本层能为上一层提供服务，但要实现本层协议还需要使用下一层所提供的服务


**二者区别**

- 协议是控制对等实体之间通信的规则，是水平的

- 服务是下层通过层间接口向上层提供的功能，是垂直的


**二者关系**

+ 协议的实现保证了能够向上一层提供服务，要实现本层协议还需使用下层提供的服务

## 计算机网络为什要分层？

- 各层之间相互独立。某一层并不需要知道它的下一层是如何实现的，而仅仅需要知道该层通过层间的接口（即界面）所提供的服务。由于每一层只实现一种相对独立的功能，因而可将一个难以处理的复杂问题分解为若干个较容易处理的更小一些的问题。这样，整个问题的复杂程度就下降了

- 灵活性好。当任何一层发生变化时（例如由于技术的变化），只要层间接口关系保持不变，则在这层以上或以下各层均不受影响。此外，对某一层提供的服务还可进行修改，当某层提供的服务不再需要时，甚至可以将这层取消

- 结构上可分割，易于实现和维护。各层都可以采用最合适的技术来实现，这种结构使得实现和调试一个庞大而又复杂的系统变得易于处理，因为整个的系统已被分解为若干个相对独立的子系统

- 能促进标准化工作。因为每一层的功能及其所提供的服务都已有了精确的说明

当然，分层当然也有一些缺点，比如有些功能会在不同的层次中重复出现，因而产生了额外开销
# 数据链路层

## 什么是 ARP 协议？

ARP协议（Address Resolution Protocol），全称**地址解析协议**。其作用是将已知 IP 地址转换为 MAC 地址，因为在以太网环境中，数据的传输所依懒的是 MAC 地址而非 IP 地址

每个主机都会在自己的 ARP 缓冲区中建立一个 ARP 列表，以表示 IP 地址和 MAC 地址之间的对应关系。ARP缓存（ARP表）是 ARP地址解析协议能够高效运行的关键

- 主机（网络接口）新加入网络时（也可能只是mac地址发生变化，接口重启等），会发送免费ARP报文把自己IP地址与Mac地址的映射关系广播给其它主机；

- 网络上的主机接收到免费 ARP 报文时，会更新自己的ARP缓冲区。将新的映射关系更新到自己的ARP表中；

- 某个主机需要发送报文时，首先检查 ARP 列表中是否有对应 IP 地址的目的主机的 MAC 地址，如果有，则直接发送数据，如果没有，就向本网段的所有主机发送 ARP 数据包，该数据包包括的内容有：源主机 IP 地址，源主机 MAC 地址，目的主机的 IP 地址等；

- 当本网络的所有主机收到该 ARP 数据包时

  - 首先检查数据包中的 IP 地址是否是自己的 IP 地址，如果不是，则忽略该数据包
  - 如果是，则首先从数据包中取出源主机的 IP 和 MAC 地址写入到 ARP 列表中，如果已经存在，则覆盖
  - 然后将自己的 MAC 地址写入 ARP 响应包中，告诉源主机自己是它想要找的 MAC 地址
- 源主机收到 ARP 响应包后。将目的主机的 IP 和 MAC 地址写入 ARP 列表，并利用此信息发送数据。如果源主机一直没有收到 ARP 响应数据包，表示 ARP 查询失败

## 什么是 Ethernet 以太网协议？

+ 以太网是局域网使用最广泛的协议之一，由于部署简单，价格低廉，被 IEEE 委员会标准化，其正式标准是 `IEEE 802.3`。**以太网协议则是用于实现链路层的数据传输和 MAC 地址封装**

![在这里插入图片描述](https://raw.githubusercontent.com/feixue-altaaa/picture/master/pic/202307062113373.png)

+ 如图所示，以太网的数据帧由它由 6 字节的**目的 MAC 地址**，6 字节的**源 MAC 地址**，2 字节的***类型域（用于标示封装在这个 Frame 里面的数据的类型）**。接下来是 46-1500 字节的数据和 4 字节的帧校验

## 什么是 PPP 协议？

+ PPP 全程 Point to Point Protocol，中文为点对点协议。是为在同等单元之间传输数据包这样的简单链路设计的链路层协议。这种链路提供全双工操作，并按照顺序传递数据包。设计目的主要是用来通过拨号或专线方式建立点对点连接发送数据，使其成为各种主机、网桥和路由器之间简单连接的一种共通的解决方案

# 网络层

## 端到端、点到点的区别？

数据传输的可靠性是通过数据链路层和网络层的点对点和传输层的端对端保证的。端到端与点到点是针对网络中传输的两端设备间的关系而言的

- 端到端通信是针对传输层来说的。它是一个网络连接，指的是在数据传输之前，在发送端与接收端之间（忽略中间有多少设备）为数据的传输建立一条链路，链路建立以后，发送端就可以发送数据，知道数据发送完毕，接收端确认接收成功。 也就是说在数据传输之前，先为数据的传输开辟一条通道，然后在进行传输。从发送端发出数据到接收端接收完毕结束

- 点到点通信是针对数据链路层或网络层来说的。点对点是基于 MAC 地址或 IP 地址。指一个设备发数据给与该该设备直接连接的其他设备，这台设备又在合适的时候将数据传递给与它相连的下一个设备，通过一台一台直接相连的设备把数据传递到接收端


其主要区别还是，**端到端关心的开始与结束，点到点关心的中间过程**。可以说 端到端是由无数个点到点构成的

## 什么是 ICMP 协议？

- ICMP 全称 Internet Control Message Protocol，即 Internet 控制报文协议。它是 TCP/IP 协议簇的一个子协议，用于在IP主机、路由器之间传递控制消息
- 主要用来检测网络通信故障和实现链路追踪，最典型的应用就是 ping 和 traceroute

## 什么是 TTL 以及作用？

- TTL 是 Time To Live 的缩写，该字段指定 IP包被路由器丢弃之前允许通过的最大网段数量。（需要注意的是 TTL 与 DNS TTL 二者都是生存时间，前者指 ICMP 包的转发次数或跳数，后者指域名解析信息在DNS中的存在时间。）
- TTL 的作用是限制 IP数据包在计算机网络中的存在的时间，以避免IP包在网络中的无限循环和收发，节省了网络资源，并能使IP包的发送者能收到告警消息。TTL的最大值是255，TTL的一个推荐值是64

## VIP 协议以及地址漂移？

VIP 即虚拟 IP 地址是一个不与特定计算机或一个计算机中的网络接口卡（NIC）相连的 IP 地址。数据包被发送到这个 VIP 地址，但是所有的数据还是经过真实的网络接口。

何为虚拟IP，就是一个未分配给真实主机的IP，也就是说对外提供数据库服务器的主机除了有一个真实IP外还有一个虚拟IP，使用这两个IP中的 任意一个都可以连接到这台主机，所有项目中数据库链接一项配置的都是这个虚IP，当服务器发生故障无法对外提供服务时，动态将这个虚IP切换到备用主机。

至于如何切换，其实现原理主要是靠 TCP/IP 的 ARP 协议。因为 IP 地址只是一个逻辑地址，在以太网中 MAC 地址才是真正用来进行数据传输的物理地址，每台主机中都有一个 ARP 高速缓存，存储同一个网络内的 IP 地址与 MAC 地址的对应关系，以太网中的主机发送数据时会先从这个缓存中查询目标 IP 对应的 MAC 地址，会向这个 MAC 地址发送数据。操作系统会自动维护这个缓存，这就是整个实现的关键
# 传输层

## TCP

### TCP 和 UDP 区别？
**UDP：对网络通讯质量要求不高时，要求网络通讯速度要快的场景**

- 无连接，发送数据之前不需要建立连接
- 尽最大努力交付，不保证可靠交付，不使用拥塞控制
- 面向报文，适合多媒体通信
- 支持一对一，一对多，多对一，多对多的交互通信
- 首部开销小，8个字节

**TCP：当对网络通讯质量有要求时，比如HTTP、HTTPS、FTP等传输文件的协议， POP3、SMTP等邮件传输的协议**

- 面向连接
- 每一条TCP有且只有两个端点，为一对一关系
- 提供可靠交付
- 全双工通信，全双工为即可传输又可接收
- 面向字节流

**常问问题：**实时直播、游戏用tcp还是udp好

**回：**直播udp，速度快！，会丢包但是不卡顿，实时性好（目前tcp主流，因为tcp库多，开发周期短）

游戏tcp好，安全可靠性高，第三方库多

### TCP 如何实现可靠传输？

- 建立连接：通过三次握手建立连接，保证连接实体真实存在
- 序号机制：保证数据是按序、完整到达
- 合理分片：tcp会按最大传输单元(MTU)合理分片，接收方会缓存未按序到达的数据，重新排序后交给应用层
- 数据校验：TCP报文头有校验和，用于校验报文是否损坏
- 超时重传：如果发送一直收不到应答，可能是发送数据丢失，也可能是应答丢失，发送方再等待一段时间之后都会进行重传
- 流量控制：当接收方来不及处理发送方的数据，能通过滑动窗口，提示发送方降低发送的速率，防止包丢失
- 拥塞控制：网络层拥堵造成的拥塞，包括慢启动，拥塞避免，快速重传三种机制

### 为什么要流量控制？

- 通信双方在数据传输时，发送方的速率与接收方的速率是不一定相等，如果发送方的发送速率太快，会导致接收方处理不过来，这时候接收方只能把处理不过来的数据存在缓存区里（失序的数据包也会被存放在缓存区里）
- 如果缓存区满了发送方还在疯狂着发送数据，接收方只能把收到的数据包丢掉，大量的丢包会极大着浪费网络资源，因此，我们需要控制发送方的发送速率，让接收方与发送方处于一种动态平衡才好

- 故对发送方发送速率的控制，我们称之为流量控制







# 什么是网关？什么是路由？什么是IP?

什么是网关？

网关（Gateway）就是一个网络连接到另一个网络的“关口”。

按照不同的分类标准，网关也有很多种。TCP/IP协议里的网关是最常用的，在这里我们所讲的“网关”均指TCP/IP协议下的网关。

网关实质上是一个网络通向其他网络的IP地址。比如有网络A和网络B，网络A的IP地址范围为“192.168.1.1~192. 168.1.254”，子网掩码为255.255.255.0；网络B的IP地址范围为“192.168.2.1~192.168.2.254”，子网掩码为255.255.255.0。在没有路由器的情况下，两个网络之间是不能进行TCP/IP通信的，即使是两个网络连接在同一台交换机（或集线器）上，TCP/IP协议也会根据子网掩码（255.255.255.0）判定两个网络中的主机处在不同的网络里。而要实现这两个网络之间的通信，则必须通过网关。如果网络A中的主机发现数据包的目的主机不在本地网络中，就把数据包转发给它自己的网关，再由网关转发给网络B的网关，网络B的网关再转发给网络B的某个主机。网络B向网络A转发数据包的过程也是如此。

所以说，只有设置好网关的IP地址，TCP/IP协议才能实现不同网络之间的相互通信。那么这个IP地址是哪台机器的IP地址呢？网关的IP地址是具有路由功能的设备的IP地址，具有路由功能的设备有路由器、启用了路由协议的服务器（实质上相当于一台路由器）、代理服务器（也相当于一台路由器）。

什么是路由？

路由器（Router）是一种负责寻径的网络设备，它在互连网络中从多条路径中寻找通讯量最少的一条网络路径提供给用户通信。路由器用于连接多个逻辑上分开的网络。对用户提供最佳的通信路径，路由器利用路由表为数据传输选择路径，路由表包含网络地址以及各地址之间距离的清单，路由器利用路由表查找数据包从当前位置到目的地址的正确路径。路由器使用最少时间算法或最优路径算法来调整信息传递的路径，如果某一网络路径发生故障或堵塞，路由器可选择另一条路径，以保证信息的正常传输。路由器可进行数据格式的转换，成为不同协议之间网络互连的必要设备。

路由器使用寻径协议来获得网络信息，采用基于“寻径矩阵”的寻径算法和准则来选择最优路径。按照OSI参考模型，路由器是一个网络层系统。路由器分为单协议路由器和多协议路由器。

比如你说的那几个,说的通俗一点:如果给你一个IP地址为116.24.143.126,子网掩码255.255.255.224,也就是在这段地址中有32个地址,其中30个可用,去掉网关,还有29个可分配.地址是从116.24.143.96-127,第一个可用的IP是97,最后一个是126,这个例子里,你拿126做网关了,所以从97至125这29个地址是可被你分配的. 同理.116.24.143.126,掩码255.255.255.0,那你就有253个地址可被你分配使用.也就是1-125,127-254. 116.24.143.166,掩码是255.255.255.128,就是有125个地址可被你分配使用.即129-165,167-254. 每段地址有多少可用,不是看IP的最后一位数,而是看子网掩码

什么是IP?

所谓IP地址就是给每个连接在Internet上的主机分配的一个32bit地址。 按照TCP/IP(Transport Control Protocol/Internet Protocol，传输控制协议/Internet协议)协议规定，IP地址用二进制来表示，每个IP地址长32bit，比特换算成字节，就是4个字节。例如一个采用二进制形式的IP地址是“00001010000000000000000000000001”，这么长的地址，人们处理起来也太费劲了。为了方便人们的使用，IP地址经常被写成十进制的形式，中间使用符号“.”分开不同的字节。于是，上面的IP地址可以表示为“10.0.0.1”。IP地址的这种表示法叫做“点分十进制表示法”，这显然比1和0容易记忆得多。 有人会以为，一台计算机只能有一个IP地址，这种观点是错误的。我们可以指定一台计算机具有多个IP地址，因此在访问互联网时，不要以为一个IP地址就是一台计算机;另外，通过特定的技术，也可以使多台服务器共用一个IP地址，这些服务器在用户看起来就像一台主机似的。
